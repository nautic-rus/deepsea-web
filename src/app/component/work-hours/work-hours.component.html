<div class="all-page">
  <div class="card">
    <div class="calendar-header">
      <div class="cy width-200">
        <p-multiSelect styleClass="width-200" [options]="departments" [(ngModel)]="selectedDepartments" optionLabel="label" optionValue="value"></p-multiSelect>
      </div>

      <div class="df ml-20 w-80">
        <div class="cxy cursor-pointer prev-month blue-button" (click)="fillPrevDays()">
          <img src="assets/icons/arrow-l.svg" height="16">
        </div>
        <div class="cxy cursor-pointer next-month blue-button" (click)="fillNextDays()">
          <img src="assets/icons/arrow-r2.svg" height="16">
        </div>
      </div>
      <div class="width-425 pl-25 cy">
        <div class="w-100 df space-between">
          <div class="mr-10">
            <div class="materials-button gray-button cxy" (click)="clearFilters()" [pTooltip]="t.tr('Очистить фильтры')" tooltipPosition="top">
              <img src="assets/icons/filter-no.svg" height="18">
            </div>
          </div>
          <div class="mr-1 cy mt-10">
            <label class="container margin-bottom-none">
              <span class="text-checkbox">{{t.tr('Показать незапланированные')}}</span>
              <input (change)="filterIssues()" type="checkbox" [(ngModel)]="showWithoutPlan">
              <span class="checkmark"></span>
            </label>
          </div>
        </div>

      </div>

    </div>
    <div class="df">
      <div class="users-days">
        <div class="df sticky">
          <div class="w-15 min-width-200 users pl-10 header-users">
            <span>{{t.tr('Сотрудники')}}</span>
          </div>
          <div class="w-85">
            <div class="calendar w-100">
              <div class="month-date">
                <!--              <div *ngFor="let day of getDaysInMonth()" [class.off-day]="isWeekend(day)" [class.today-day]="isCurrentDay(day)" class="day-number-header cxy">{{day}}<span *ngIf="isShorter(day)">*</span></div>-->
                <div *ngFor="let pDay of headerPDays" [class.off-day]="pDay.day_type == 3" [class.today-day]="isCurrentPDay(pDay)" class="day-number-header cxy position-relative">
                  <div class="plan-day-day">{{pDay.day}}<span *ngIf="pDay.day_type == 2">*</span></div>
                  <div class="plan-day-month">{{formatMonth(pDay.month)}}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="df hover-user" *ngFor="let user of getUsers()">
          <div class="w-15 min-width-200 users pl-10 cursor-pointer">
            <span>{{user.userName}}</span>
          </div>
          <div class="w-85">
            <div class="calendar w-100">
              <div class="month-date" #addTask>
                <!--              <div *ngFor="let day of getDaysInMonth()" tabindex="1" [class.management]="user.visibility.includes('r')" (mouseenter)="setHover(day, user)" (mouseleave)="resetHover()" [class.day-border]="dayHover == day && userHover == user" (contextmenu)="selectDay(day)" [class.off-day]="isWeekend(day)" [class.today-days]="isCurrentDay(day)" class="day-number cxy"></div>-->
                <div pDroppable="issue" (onDrop)="dragDrop($event, pDay, user)" #day *ngFor="let pDay of userPDays[user.id]" [class.off-day]="pDay.day_type == 3" [class.border-none]="hasTask(pDay)" class="day-number cxy" (contextmenu)="selectDay(pDay, user)">
                  <span *ngIf="pDay.day_type == 2"></span>
                  <div (click)="openTask(task.taskId)" *ngFor="let task of getTasksOfDay(pDay)" [ngStyle]="getDayStyle(task)" class="plan-hours">
                    {{task.planHours.length}}
                  </div>
                </div>
              </div>
            </div>
            <p-contextMenu #contextMenu (onHide)="hoverEnabled = true" [target]="addTask" appendTo="body" [model]="items"></p-contextMenu>
          </div>
        </div>

        <div  *ngIf="loading">
          <div class="cxy loading">
            <div class="cxy flex-column">
              <img src="assets/whale.gif" height="120">
              <div class="cx loading-text">PLEASE WAIT...</div>
            </div>
          </div>
        </div>

      </div>
      <div class="width-425">
        <div class="df space-between">
          <div class="ml-20">
            <div class="big-text-user mb-1">{{t.tr('Проект')}}</div>
            <p-dropdown appendTo = "body" placeholder="Project" [(ngModel)]="project" optionValue="name" [options]="projects" styleClass="width-130" (ngModelChange)="projectChanged()"></p-dropdown>
          </div>
          <div>
            <div class="big-text-user mb-1">{{t.tr('Отдел')}}</div>
            <p-dropdown appendTo = "body" placeholder="Department" [(ngModel)]="department" [options]="departments" (ngModelChange)="departmentChanged()" styleClass="width-130"></p-dropdown>
          </div>
        </div>
        <div class="df space-between ">
          <div class="ml-20">
            <div class="big-text-user mb-1 mt-4px">{{t.tr('Этап')}}</div>
            <p-dropdown appendTo = "body" placeholder="Stage" [(ngModel)]="stage" [options]="stages" (ngModelChange)="stageChanged()" styleClass="width-130"></p-dropdown>
          </div>
          <div>
            <div class="big-text-user mb-1 mt-4px">{{t.tr('Тип')}}</div>
            <p-dropdown appendTo = "body" placeholder="Type" [(ngModel)]="taskType" [options]="taskTypes" (ngModelChange)="taskTypeChanged()" styleClass="width-130"></p-dropdown>
          </div>
        </div>

        <div class="df space-between mb-10">
          <div class="ml-20">
            <div class="big-text-user mb-1 mt-4px">{{t.tr('Статус')}}</div>
            <p-dropdown appendTo = "body" placeholder="Status" [(ngModel)]="status" [options]="statuses" (ngModelChange)="statusChanged()" styleClass="width-130"></p-dropdown>
          </div>
          <div>
            <div class="big-text-user mb-1 mt-24"></div>
            <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input [(ngModel)]="searchValue" (ngModelChange)="filterIssues()" pInputText type="text" [placeholder]="t.tr('Поиск...')" class="border width-130" />
          </span>
          </div>
        </div>

        <cdk-virtual-scroll-viewport class="background-gray" autosize style="height: calc(100vh - 390px)">
          <div class="h-100 issues-all" *cdkVirtualFor="let issue of issues">
            <div pDraggable="issue" (dragstart)="drag($event, issue, dragValues[issue.id])" class="cursor-pointer"  (click)="selectIssue(issue)">
              <div class="one-row-w df space-between">
                <div class="title-bold">{{issue.doc_number}}</div>
                <div [innerHTML]="issueManager.localeStatus(issue.status) | safeHtml"></div>
              </div>
              <div class="text-mini-gray mb-5">
                <div>{{issue.name}}</div>
              </div>
              <div class="df mm-text space-between mb-5">
                <div class="mm-text df">
                  <div>{{t.tr('Исполнитель') + ' ' + '-'}}</div>
                  <div class="pl-2px">{{auth.getUserName(issue.assigned_to)}}</div>
                </div>
                <div class="df">
                  <img src="assets/icons/flag-finish.svg" height="20">
                  <div>{{getDateOnly(issue.contract_due_date)}}</div>
                </div>
              </div>
              <div class="df text-black-mini">
              <span class="cy width-20">
                <div>{{getPlanned(issue)}}</div>
              </span>
                <span class="mx-10 cy">/</span>
                <span class="cursor-pointer width-50 mr-15">
                  <p-inputNumber inputStyleClass="width-50" [(ngModel)]="dragValues[issue.id]" mode="decimal"></p-inputNumber>
                </span>
              </div>










            </div>





<!--            <div>-->
<!--              <span>{{getPlanned(issue)}}</span>-->
<!--              <span>/</span>-->
<!--              <span>{{issue.plan_hours}}</span>-->
<!--            </div>-->
<!--            <p-inputNumber [(ngModel)]="dragValues[issue.id]"></p-inputNumber>-->
          </div>
        </cdk-virtual-scroll-viewport>
      </div>
    </div>
  </div>
</div>




