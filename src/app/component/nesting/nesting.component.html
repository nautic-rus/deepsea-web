<div *ngIf="device.isDesktop()" class="all-page min-height">
  <div class="">
    <div class="card-head mb-20 df">
      <div class="mr-1">
        <button pButton [pTooltip]="l.tr('Export Nesting')" tooltipPosition="top" class="border normal-button p-button-outlined" icon="pi pi-file-excel" (click)="exportXls()"></button>
      </div>
      <div class="mr-1">
        <button pButton [pTooltip]="l.tr('Download Files for Nestings in table')" tooltipPosition="top" class="border normal-button p-button-outlined" icon="pi pi-download" (click)="downloadFiles()"></button>
      </div>
      <span class="p-input-icon-left p-ml-auto">
        <i class="pi pi-search"></i>
        <input pInputText type="text" [placeholder]="l.tr('Поиск...')" [(ngModel)]="search" (ngModelChange)="searchChanged()" class="border" />
      </span>
    </div>
    <div class="w-100 df">
      <div class="w-100 df">
        <div class="w-20">
          <div class="menu-card">
            <div class="ovf-auto">
              <div class="df">
                <div class="title-bold mb-15 sticky head-checkbox">BLOCKS:</div>
                <div class="p-ml-auto df">
                  <div *ngIf="currentView == 'tile'" class="mr-10 cursor-pointer">
                    <img src="assets/icons/tile-yellow.svg" height="24">
                  </div>
                  <div (click)="currentView = 'tile'" *ngIf="currentView != 'tile'" class="mr-10 cursor-pointer">
                    <img src="assets/icons/tile-gray.svg" height="24">
                  </div>
                  <div *ngIf="currentView == 'list'" class="cursor-pointer">
                    <img src="assets/icons/list-yellow.svg" height="24">
                  </div>
                  <div (click)="currentView = 'list'" *ngIf="currentView != 'list'" class="cursor-pointer">
                    <img src="assets/icons/list-gray.svg" height="24">
                  </div>
                </div>

              </div>

              <div class="gray-text" *ngIf="blocks.length == 0 && !loadingBlocks">
                There is no blocks for selected project there. Try to specify another project.
              </div>
              <div *ngFor="let block of blocks">
                <label class="container">
                  <input (change)="selectBlock(block)" type="checkbox" [checked]="block.selected">
                  <span class="checkmark"></span>
                  <span class="text-checkbox">{{block.name}}</span>
                </label>
              </div>
            </div>
            <div class="w-100">
              <div class="button-fetch cxy cursor-pointer mt-10 mb-20" (click)="fetchMaterials()">FETCH MATERIALS</div>
            </div>
            <div class="ovf-auto">
              <div class="title-bold mb-15 sticky head-checkbox">MATERIALS:</div>
              <div class="cxy" *ngIf="loadingMaterials">
                <p-progressSpinner [style]="{width: '70px', height: '70px'}" styleClass="custom-spinner" strokeWidth="3" fill="#fff" animationDuration="1s"></p-progressSpinner>
              </div>
              <div class="gray-text" *ngIf="materials.length == 0 && !loadingMaterials">
                There are no plate dimensions. You need to specify blocks from top column.
              </div>
              <div *ngFor="let material of materials">
                <label class="container">
                  <input (change)="selectMaterial(material)" type="checkbox" [checked]="material.selected">
                  <span class="checkmark"></span>
                  <span class="text-checkbox">{{material.name}}</span>
                </label>
              </div>
            </div>
            <div>
              <div class="button-fetch cxy cursor-pointer mt-1" *ngIf="materials.length > 0" (click)="fetchNesting()">FETCH NESTING</div>
            </div>
          </div>
        </div>
        <div class="w-80 cards">
          <div class="cxy card-height" *ngIf="noResult">
            <div class="cx loading-text">No data fetched from server with selected options. Try to select another one.</div>
          </div>
          <div *ngIf="loading && !noResult">
            <div class="cxy loading">
              <div class="cxy card-height">
                <img src="assets/whale.gif" height="120">
                <div class="cx loading-text">PLEASE WAIT...</div>
              </div>
            </div>
          </div>
          <div *ngIf="!noResult && nesting.length == 0">
            <div class="cxy card-height">
              <div class="cx loading-text">There is no data there. You need to specify blocks and dimensions from left column.</div>
            </div>
          </div>
          <div *ngIf="currentView == 'list'">
            <div [class.hidden-card]="nest == null" class="dash-card mx-20" *ngFor="let nest of nesting; let i = index">
              <div *ngIf="nest != null" class="top-row">
                <div class="cxy">
                  <div class="cxy lock cursor-pointer" *ngIf="nest.LOCKED" (click)="nest.LOCKED = !nest.LOCKED">
                    <img src="assets/icons/lock.svg" height="26">
                  </div>
                  <div class="cxy unlock cursor-pointer" *ngIf="!nest.LOCKED" (click)="nest.LOCKED = !nest.LOCKED">
                    <img src="assets/icons/unlock.svg" height="26">
                  </div>
                </div>
                <div class="">
                  <div class="cy h-100">
                    <div class="cx mb-10 mt-10">
                      <div class="title-bold px-10">{{nest.ID}}</div>
                    </div>
                  </div>
                </div>
                <div class="text-center-y">
                  <div class="title-name">
                    <div *ngIf="nest.USAGE > 100">WARNING</div>
                    <ngx-charts-pie-chart [view]="[120, 120]" [customColors]="[{name: 'Usage', value: '#f9c851'}, {name: 'Left', value: '#BE78A2'}]" [results]="nest.doughnut" [gradient]="false" [legend]="false" [labels]="false" [doughnut]="false"></ngx-charts-pie-chart>
                  </div>
                  <div class="title-name">
                    <div class="my-5 usage">Usage: {{round(nest.USAGE)}}%</div>
                    <div class="my-5 left">Left: {{round(100 - nest.USAGE)}}%</div>
                  </div>
                </div>
                <div class="text-center-y">
                  <div class="gray-text mr-10">File</div>
                  <div class="file">{{nest.FILE}}</div>
                  <div *ngIf="!isDisabledNestTemplate(nest)" class="ml-10 cxy eye-file cursor-pointer" (click)="showNestingTemplate(nest); $event.stopPropagation()" [pTooltip]="l.tr('Show nesting file')" tooltipPosition="top">
                    <img src="assets/icons/eye-file.svg" height="22">
                    <div class="eye-tooltip" *ngIf="showTooltip('t' + i)">Show nesting file</div>
                  </div>
                  <div *ngIf="!isDisabledNestTemplate(nest)" class="ml-10 cxy eye-file cursor-pointer" (click)="downloadNestingFile(nest); $event.stopPropagation()" [pTooltip]="l.tr('Download file')" tooltipPosition="top">
                    <img src="assets/icons/download-file.svg" height="22">
                    <div class="eye-tooltip" *ngIf="showTooltip('t' + i)">Download files</div>
                  </div>



                  <div *ngIf="!isDisabledCuttingMap(nest)" class="ml-10 cxy eye-file cursor-pointer" (click)="showCuttingFile(nest); $event.stopPropagation()" [pTooltip]="l.tr('Show cutting file')" tooltipPosition="top">
                    <img src="assets/icons/eye-file.svg" height="22">
                    <div class="eye-tooltip" *ngIf="showTooltip('t' + i)">Show cutting file</div>
                  </div>
                  <div *ngIf="!isDisabledCuttingMap(nest)" class="ml-10 cxy eye-file cursor-pointer" (click)="showCuttingFile(nest); $event.stopPropagation()" [pTooltip]="l.tr('Show cutting file')" tooltipPosition="top">
                    <img src="assets/icons/download-file.svg" height="22">
                    <div class="eye-tooltip" *ngIf="showTooltip('t' + i)">Show cutting file</div>
                  </div>
                </div>
              </div>
              <div *ngIf="nest != null" class="bottom-row">
                <div class="ovf-auto">
                  <div class="df cursor-pointer sticky">
                    <div class="w-25 table-header-column cy">{{l.tr('BLOCK')}}</div>
                    <div class="w-25 table-header-column cy">{{l.tr('LENGTHxWIDTHxTHICKNESS')}}</div>
                    <div class="w-25 table-header-column cy">{{l.tr('MATERIAL')}}</div>
                    <div class="w-25 table-header-column cy">{{l.tr('WEIGHT')}}</div>
                    <div class="w-25 table-header-column cy">{{l.tr('NUMBER EQUAL NESTING')}}</div>
                  </div>
                  <div class="text-center-y info-row cursor-pointer">
                    <div class="w-25 table-body cy">{{nest.BLOCKS}}</div>
                    <div class="w-25 table-body cy">{{nest.THICKNESS + 'x'}}{{nest.NEST_LENGTH + 'x'}}{{nest.NEST_WIDTH}}</div>
                    <div class="w-25 table-body cy">{{nest.MATERIAL}}</div>
                    <div class="w-25 table-body cy">{{nest.PARTS_WEIGHT}}</div>
                    <div class="w-25 table-body cy">{{nest.NUM_EQ_NEST}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="currentView == 'tile'" class="tile">
            <div [class.hidden-card]="nest == null" class="dash-card-tile" *ngFor="let nest of nesting; let i = index">
              <div *ngIf="nest != null" class="top-row-tile">
                <div class="cy">
                  <div class="cxy">
                    <div class="cxy lock cursor-pointer" *ngIf="nest.LOCKED" (click)="nest.LOCKED = !nest.LOCKED">
                      <img src="assets/icons/lock.svg" height="22">
                    </div>
                    <div class="cxy unlock cursor-pointer" *ngIf="!nest.LOCKED" (click)="nest.LOCKED = !nest.LOCKED">
                      <img src="assets/icons/unlock.svg" height="22">
                    </div>
                  </div>
                  <div class="">
                    <div class="cy h-100">
                      <div class="cx mb-10 mt-10">
                        <div class="title-bold px-10">{{nest.ID}}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="text-center-y">
                  <div class="mt-minus15">
                    <div *ngIf="nest.USAGE > 100">WARNING</div>
                    <ngx-charts-pie-chart [view]="[120, 120]" [customColors]="[{name: 'Usage', value: '#f9c851'}, {name: 'Left', value: '#D8DADC'}]" [results]="nest.doughnut" [gradient]="false" [legend]="false" [labels]="false" [doughnut]="true"></ngx-charts-pie-chart>
                  </div>
                  <div class="donut-text">{{round(nest.USAGE)}}%

                  </div>
                  <div class="usage-left-info">
                    <div class="text-center-y">
                      <div class="usage-tile cxy">
                        <img src="assets/icons/usage.svg" height="16">
                      </div>
                      <div class="ml-5">
                        <div class="usage-left-text">Usage</div>
                        <div class="usage-left-percent">{{round(nest.USAGE)}}%</div>
                      </div>
                    </div>
                    <div class="text-center-y">
                      <div class="left-tile cxy">
                        <img src="assets/icons/scales.svg" height="16">
                      </div>
                      <div class="ml-5">
                        <div class="usage-left-text">Left</div>
                        <div class="usage-left-percent">{{round(100 - nest.USAGE)}}%</div>
                      </div>
                    </div>
                  </div>

                </div>
                <div class="">
                  <div class="files-tile">
                    <div class="">
                      <div class="gray-text-tile cx mb-1px">Nesting:</div>
                      <div class="cxy">
                        <div *ngIf="!isDisabledNestTemplate(nest)" class="cxy eye-file-tile cursor-pointer mr-10" (click)="showNestingTemplate(nest); $event.stopPropagation()" [pTooltip]="l.tr('Show nesting file')" tooltipPosition="top">
                          <img src="assets/icons/eye-file.svg" height="18">
                        </div>
                        <div *ngIf="!isDisabledNestTemplate(nest)" class="cxy eye-file-tile cursor-pointer" (click)="downloadNestingFile(nest); $event.stopPropagation()" [pTooltip]="l.tr('Download nesting file')" tooltipPosition="top">
                          <img src="assets/icons/download-file.svg" height="18">
                        </div>
                      </div>

                    </div>
                    <div class="">
                      <div class="gray-text cx mb-1px">Cutting:</div>
                      <div class="cxy">
                        <div *ngIf="!isDisabledCuttingMap(nest)" class="cxy eye-cut-tile cursor-pointer mr-10" (click)="showCuttingFile(nest); $event.stopPropagation()" [pTooltip]="l.tr('Show cutting file')" tooltipPosition="top">
                          <img src="assets/icons/eye-file.svg" height="18">
                        </div>
                        <div *ngIf="!isDisabledCuttingMap(nest)" class="cxy eye-cut-tile cursor-pointer" (click)="downloadCuttingFile(nest); $event.stopPropagation()" [pTooltip]="l.tr('Download cutting file')" tooltipPosition="top">
                          <img src="assets/icons/download-file.svg" height="18">
                        </div>
                      </div>

                    </div>

                  </div>
                </div>

              </div>
              <div *ngIf="nest != null" class="bottom-row">
                <div class="ovf-auto">
                  <div class="df cursor-pointer sticky">
                    <div class="w-30 table-header-column cy">{{l.tr('BLOCK')}}</div>
                    <div class="w-35 table-header-column cy">{{l.tr('LxWxT')}}</div>
                    <div class="w-15 table-header-column cy">{{l.tr('MAT.')}}</div>
                    <div class="w-30 table-header-column cy">{{l.tr('WEIGHT')}}</div>
                    <div class="w-15 table-header-column cy">{{l.tr('N')}}</div>
                  </div>
                  <div class="text-center-y info-row cursor-pointer">
                    <div class="w-30 table-body cy">{{nest.BLOCKS}}</div>
                    <div class="w-35 table-body cy">{{nest.THICKNESS + 'x'}}{{nest.NEST_LENGTH + 'x'}}{{nest.NEST_WIDTH}}</div>
                    <div class="w-15 table-body cy">{{nest.MATERIAL}}</div>
                    <div class="w-30 table-body cy">{{nest.PARTS_WEIGHT}}</div>
                    <div class="w-15 table-body cy">{{nest.NUM_EQ_NEST}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="pt-5 dxf-view" *ngIf="dxfEnabled">
        <button pButton [pTooltip]="l.tr('Download')" tooltipPosition="top" class="border normal-button p-button-outlined dxf-open-button dxf-download-window" icon="pi pi-download" (click)="downloadOpenedDxf()"></button>
        <button pButton [pTooltip]="l.tr('Open in new window')" tooltipPosition="top" class="border normal-button p-button-outlined dxf-open-button dxf-open-new-window" icon="pi pi-external-link" (click)="openDxf()"></button>
        <button pButton [pTooltip]="l.tr('Exit viewer')" tooltipPosition="top" class="border normal-button p-button-outlined dxf-open-button dxf-exit" icon="pi pi-sign-out" (click)="exitDxf()"></button>
        <app-dxf-view></app-dxf-view>
      </div>
      <div class="pt-5 dxf-view" *ngIf="cutEnabled">
        <button pButton [pTooltip]="l.tr('Download')" tooltipPosition="top" class="border normal-button p-button-outlined dxf-open-button dxf-download-window" icon="pi pi-download" (click)="downloadOpenedCMAP()"></button>
        <button pButton [pTooltip]="l.tr('Open in new window')" tooltipPosition="top" class="border normal-button p-button-outlined dxf-open-button dxf-open-new-window" icon="pi pi-external-link" (click)="openCMAP()"></button>
        <button pButton [pTooltip]="l.tr('Exit viewer')" tooltipPosition="top" class="border normal-button p-button-outlined dxf-open-button dxf-exit" icon="pi pi-sign-out" (click)="exitDxf()"></button>
        <app-g-code></app-g-code>
      </div>
    </div>
  </div>
</div>


<div class="progress-spinner" *ngIf="waitForZipFiles">
  <div class="image-preview-backdrop" (click)="closeShowImage()">
  </div>
  <div class="image-preview-scale">
    <img src="assets/whale.gif" height="120">
    <div class="cx wait-text">PLEASE WAIT...</div>
  </div>
</div>

<div [hidden]="!showImages">
  <div class="image-preview-backdrop" (click)="closeShowImage()">
  </div>
  <div class="image-preview-scale">
    <img #img class="image-preview" data-wheel-zoom [src]="image" style="height: unset; width: unset"/>
  </div>
</div>


<!--    <div *ngIf="parts.length == 0 && !noResult">-->
<!--      <div class="cxy">-->
<!--        <div>-->
<!--          <img src="assets/whale.gif" height="120">-->
<!--          <div class="cx ">PLEASE WAIT...</div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->


