<div class="w70">
  <div class="task-header">
    <div class="text-head text-bottom">{{issueManager.localeTaskType(issue.taskType)}}</div>
    <div class="task-buttons">
      <div class="task-button cxy" pTooltip="Копировать ссылку задачи" (click)="copyIssueUrl()">
        <img src="assets/icons/link.svg" height="20">
      </div>
      <div class="task-button cxy" pTooltip="Копировать задачу" (click)="copyIssue()">
        <img src="assets/icons/copy.svg" height="20">
      </div>
      <div class="task-button cxy mr-2" pTooltip="Удалить задачу" (click)="removeIssue()" [class.button-disabled]="!(auth.hasPerms('remove_issues') || this.auth.getUser().login == issue.startedBy)">
        <img src="assets/icons/trash.svg" height="20">
      </div>
      <div class="task-button cxy" (click)="close()">
        <img src="assets/icons/close.svg" height="20">
      </div>
    </div>
  </div>
  <div class="center">
    <div class="left-content">
      <div class="pb-10">
        <div *ngIf="issue.taskType != 'Approval'" class="task-name hover-task cursor-pointer padding-8" [hidden]="edit == 'name'" (click)="edit = 'name'">{{issue.docNumber}} {{issue.name}}</div>
        <div *ngIf="issue.taskType == 'Approval'" class="task-name hover-task cursor-pointer padding-8" [hidden]="edit == 'name'" (click)="edit = 'name'">Согласование {{issue.docNumber}}</div>
        <div class="task-name" [hidden]="edit != 'name'">
          <textarea *ngIf="edit == 'name'" type="text" pInputTextarea [autoResize]="true" [(ngModel)]="issue.name" class="w-100 task-name-change font"></textarea>
          <div class="content-end">
            <div class="task-name-button cxy mr-5" (click)="commitIssueEdit()">
              <img src="assets/icons/tick.svg">
            </div>
            <div class="task-name-button cxy" (click)="cancelIssueEdit()">
              <img src="assets/icons/cancel.svg">
            </div>
          </div>
        </div>
      </div>
      <div class="buttons">
        <div class="buttons-pick-assign cursor-pointer" (click)="assignTask()" *ngIf="issue.activities.includes('Assign Task') && (issue.startedBy == auth.getUser().login || issue.responsible == auth.getUser().login)">
        <span class="icon-assign cxy">
          <img src="assets/icons/user.svg">
        </span>
          <span class="cxy button-text">Назначить</span>
        </div>
        <div class="buttons-pick-change cursor-pointer" (click)="changeResponsible()" *ngIf="issue.activities.includes('Assign Task') && (issue.startedBy == auth.getUser().login || issue.responsible == auth.getUser().login)">
        <span class="icon-change cxy">
          <img src="assets/icons/change.svg">
        </span>
          <span class="cxy button-text">Сменить ответственного</span>
        </div>
        <div class="button-status" *ngFor="let status of availableStatusesNoCurrent">
          <div (click)="changeStatus(status.value)" [innerHTML]="issueManager.localeStatusAsButton(status.value) | safeHtml"></div>
        </div>
      </div>
        <div class="df">
          <div class="big-text mb-1 mt-2">Описание задачи</div>
        </div>
        <div class="text description descr-task">
          <quill-view [hidden]="edit == 'description'" [content]="issue.details" (click)="editorClicked($event)"></quill-view>
        </div>
        <div class="" [hidden]="edit != 'description'">
          <quill-editor (onEditorCreated)="quillCreated($event)" [modules]="quillModules" (contextmenu)="editorClicked($event)" placeholder="" (dragover)="$event.stopPropagation(); $event.preventDefault();" (drop)="onEditorDrop($event)" [(ngModel)]="issue.details">
            <div quill-editor-toolbar>
              <p-header>
          <span class="ql-formats">
            <button class="ql-bold quill-button" pTooltip="Полужирный Ctrl+B" tooltipPosition="top" aria-label="Bold" tabindex="-1"></button>
            <button class="ql-italic quill-button" pTooltip="Курсив Ctrl+I" tooltipPosition="top" aria-label="Italic" tabindex="-1"></button>
            <button class="ql-underline quill-button" pTooltip="Подчеркнутый Ctrl+U" tooltipPosition="top" aria-label="Underline" tabindex="-1"></button>
          </span>
          <span class="ql-formats">
            <select class="ql-color quill-button" pTooltip="Цвет текста" tooltipPosition="top" tabindex="-1"></select>
            <select class="ql-background quill-button" pTooltip="Фон текста" tooltipPosition="top" tabindex="-1"></select>
          </span>
          <span class="ql-formats">
            <button class="ql-list quill-button" pTooltip="Нумерованный список" tooltipPosition="top" value="ordered" aria-label="Ordered List" tabindex="-1"></button>
            <button class="ql-list quill-button" pTooltip="Маркированный список" tooltipPosition="top" value="bullet" aria-label="Unordered List" tabindex="-1"></button>
            <select class="ql-align quill-button" pTooltip="Выравнивание" tooltipPosition="top" tabindex="-1">
              <option selected tabindex="-1"></option>
              <option value="center" tabindex="-1"></option>
              <option value="right" tabindex="-1"></option>
              <option value="justify" tabindex="-1"></option>
            </select>
          </span>
          <span class="ql-formats">
            <button class="ql-link quill-button" pTooltip="Ссылка Ctrl+K" tooltipPosition="top" aria-label="Insert Link" tabindex="-1"></button>
            <button class="quill-button" pTooltip="Файлы и изображения" tooltipPosition="top" (click)="selectImage.click()">
              <i class="pi pi-image"></i>
            </button>
            <input hidden #selectImage type="file" accept="image/*" (change)="handleImageInput(selectImage.files)" multiple>
            <button class="ql-code-block quill-button" pTooltip="Фрагмент кода" tooltipPosition="top" aria-label="Insert Code Block" tabindex="-1"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-clean quill-button" pTooltip="Отменить форматирование" tooltipPosition="top" aria-label="Remove Styles" tabindex="-1"></button>
          </span>
              </p-header>
            </div>
          </quill-editor>
          <div class="df mt-5">
            <div class="mr-5 pb-20">
              <div (click)="commitIssueEdit()" pRipple pButton label="Сохранить" class="button"></div>
            </div>
            <div>
              <div (click)="cancelIssueEdit()" pRipple pButton label="Отменить" class="button-cancel"></div>
            </div>
          </div>

        </div>
        <div class="big-text mb-1 mt-2">Вложения</div>
        <div class="attachments">
          <div *ngFor="let file of issue.fileAttachments">
            <div (click)="openFile(file.url)" class="attachment">
              <div class="cxy attachment-center">
                <img [src]="'assets/task/' + getFileExtensionIcon(file.name)" height="45"/>
              </div>
              <div class="attachment-footer">
                <div [pTooltip]="file.name">{{trimFileName(file.name)}}</div>
                <div>{{getDate(issue.startedDate)}}</div>
              </div>
            </div>
          </div>
        </div>
        <div class="big-text mb-1 mt-2" *ngIf="issue.childIssues.length > 0">Подзадачи</div>
        <div class="subtasks" *ngIf="issue.childIssues.length > 0">
          <div class="subtask cy" *ngFor="let childIssue of issue.childIssues">
            <div class="subtask-grid" (click)="openIssue(childIssue.id)" *ngIf="childIssue.taskType == 'Approval'">
              <div>Согласование</div>
              <div>
                <span>{{childIssue.docNumber + '-'}}</span>
                <span [innerHTML]="issueManager.trim(childIssue.name)"></span>
              </div>
              <div [innerHTML]="issueManager.getAssignedToTrim(childIssue.assignedTo)"></div>
              <div [innerHTML]="issueManager.localeStatus(childIssue.status) | safeHtml"></div>
            </div>
          </div>
        </div>
        <div class="big-text mb-1 mt-40">Активность</div>
        <div class="df">
          <div class="description mt-5">Показать:</div>
          <div [class.check-button]="messageFilter == 'all'" class="button-new mr-10 ml-10" (click)="messageFilter = 'all'">
            <span>Все</span>
          </div>
          <div [class.check-button]="messageFilter == 'human'" class="button-new mr-10" (click)="messageFilter = 'human'">
            <span>Комментарии</span>
          </div>
          <div [class.check-button]="messageFilter == 'camunda'" class="button-new" (click)="messageFilter = 'camunda'">
            <span>История</span>
          </div>
        </div>
        <div class="mt-1 big-text pb-20">
          <input [style]="{'width':'100%'}" [hidden]="comment" (click)="showComment()" type="text" pInputText placeholder="Напишите комментарий здесь..." />
        </div>
        <div [hidden]="!comment">
          <quill-editor (keydown)="onEditorPressed($event)" (onEditorCreated)="editorInit($event)" [modules]="quillModules" (contextmenu)="editorClicked($event)" placeholder="" (dragover)="$event.stopPropagation(); $event.preventDefault();" (drop)="onEditorDrop($event)" id="editor" [(ngModel)]="message">
            <div quill-editor-toolbar>
              <p-header>
            <span class="ql-formats">
              <button class="ql-bold" aria-label="Bold" tabindex="-1"></button>
              <button class="ql-italic" aria-label="Italic" tabindex="-1"></button>
              <button class="ql-underline" aria-label="Underline" tabindex="-1"></button>
            </span>
                <span class="ql-formats">
              <select class="ql-color" tabindex="-1"></select>
              <select class="ql-background" tabindex="-1"></select>
            </span>
                <span class="ql-formats">
              <button class="ql-list" value="ordered" aria-label="Ordered List" tabindex="-1"></button>
              <button class="ql-list" value="bullet" aria-label="Unordered List" tabindex="-1"></button>
              <select class="ql-align" tabindex="-1">
                <option selected tabindex="-1"></option>
                <option value="center" tabindex="-1"></option>
                <option value="right" tabindex="-1"></option>
                <option value="justify" tabindex="-1"></option>
              </select>
            </span>
                <span class="ql-formats">
              <button class="ql-link" aria-label="Insert Link" tabindex="-1"></button>
              <button (click)="selectImage.click()">
                <i class="pi pi-image"></i>
              </button>
              <input hidden #selectImage type="file" accept="image/*" (change)="handleImageInput(selectImage.files)" multiple>
              <button (click)="selectFiles.click()">
                <i class="pi pi-file"></i>
              </button>
              <input hidden #selectFiles type="file" (change)="handleFileInput(selectFiles.files)" multiple>
              <button class="ql-code-block" aria-label="Insert Code Block" tabindex="-1"></button>
            </span>
                <span class="ql-formats">
              <button class="ql-clean" aria-label="Remove Styles" tabindex="-1"></button>
            </span>
              </p-header>
            </div>
          </quill-editor>
          <div class="file-loading file-name mt-5" *ngFor="let file of awaitForLoad">
            <img [src]="'assets/task/' + getFileExtensionIcon(file)" height="30"/>
            <div class="cy">{{file}}</div>
            <div class="cxy"><i *ngIf="!isLoaded(file)" class="pi pi-spin pi-spinner"></i><i *ngIf="isLoaded(file)" class="pi pi-check"></i></div>
            <div class="cxy" (click)="remove(file)"><i class="pi pi-times cursor-pointer"></i></div>
          </div>
          <div class="df mt-5">
            <div class="mr-5 pb-20">
              <div (click)="sendMessage()" pButton label="Сохранить" class="button"></div>
            </div>
            <div>
              <div (click)="comment = false" pButton label="Отменить" class="button-cancel"></div>
            </div>
          </div>
        </div>
        <div class="issue-message" *ngFor="let msg of getMessages(issue)">
          <div *ngIf="(messageFilter == 'all' || messageFilter == 'human') && msg.owner == 'human'">
            <div class="df pb-20">
              <div class="pt-5 mr-10">
                <img src="{{auth.getUserAvatar(msg.author)}}" height="32" width="32" style="border-radius: 16px">
              </div>
              <div>
                <div class="">
                  <span class="bold-text">{{auth.getUserName(msg.author)}}</span>
                  <span class="text-descr"> создал{{localeGender(msg.author)}} сообщение </span>
                  <span class="text-date"> {{getDate(msg.date)}} </span>
                  <quill-view [content]="msg.content"></quill-view>
                  <div class="attachments">
                    <div *ngFor="let file of msg.fileAttachments">
                      <div (click)="openFile(file.url)" class="attachment">
                        <div class="cxy attachment-center">
                          <img [src]="'assets/task/' + getFileExtensionIcon(file.name)" height="45"/>
                        </div>
                        <div class="attachment-footer">
                          <div [pTooltip]="file.name">{{trimFileName(file.name)}}</div>
                          <div>{{getDate(msg.date)}}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="(messageFilter == 'all' || messageFilter == 'camunda') && msg.owner == 'camunda'">
          <span class="" *ngFor="let varMap of filterVariables(msg.variables)">
            <div class="df pb-30">
              <div class="pt-5 mr-10">
                <img src="{{auth.getUserAvatar(msg.author)}}" height="32" width="32" style="border-radius: 16px">
              </div>
              <div>
                <span class="bold-text">{{getAuthor(msg.author)}}</span>
                <span class="text-descr px-5">изменил{{localeGender(msg.author)}}</span>
                <span class="bold-text">{{issueManager.localeHistory(varMap.name)}}</span>
                <span class="text-date pl-5">{{getDate(msg.date)}} </span>
              <div class="df pt-5">
                <div class="" [innerHTML]="issueManager.localeStatus(getPrevValue(issue.messages, varMap.name, msg.date)) | safeHtml"></div>
                <span class="px-10">
                  <img src="assets/icons/right-arrow.svg" height="13">
                </span>
                <div [innerHTML]="issueManager.localeStatus(varMap.value) | safeHtml"></div>
              </div>
              </div>
            </div>
          </span>
          </div>
        </div>
        <div class="issue-message" *ngIf="(messageFilter == 'all' || messageFilter == 'camunda')">
          <div class="df">
            <div class="pt-5 mr-10">
              <img src="{{auth.getUserAvatar(issue.startedBy)}}" height="32" width="32" style="border-radius: 16px">
            </div>
            <div class="">
              <span class="bold-text">{{auth.getUserName(issue.startedBy)}}</span>
              <span class="text-descr"> создал{{localeGender(issue.startedBy)}} задачу</span>
              <span class="text-date"> {{getDate(issue.startedDate)}} </span>
            </div>
          </div>
        </div>
      </div>

    <div class="right-content">
      <div class="information">
        <div class="header-information text-head">Сведения</div>
        <div class="table">
          <div class="df mt-5">
            <div class="df text-y line-text normal-text w40">Статус</div>
            <div class="df text-y line-text cursor-pointer description-task w60">
              <div [innerHTML]="issueManager.localeStatus(issue.status) | safeHtml"></div>
<!--              <p-dropdown [(ngModel)]="issue.status" optionLabel="label" optionValue="value" [options]="availableStatuses" (onChange)="statusChanged()">-->
<!--              </p-dropdown>-->
            </div>
          </div>
<!--          <div class="df profession" *ngIf="issue.assignedTo != ''">-->
<!--            <div class="normal-text w-50"></div>-->
<!--            <div class="descr-task w-50">{{auth.getUserProfession(issue.assignedTo)}}</div>-->
<!--          </div>-->
          <div class="df mt-5">
            <div class="df text-y h-32 normal-text w-40">Дата начала</div>
            <div [hidden]="edit == 'startDate'" (click)="edit = 'startDate'" class="pl-3 pt-6 h-32 cursor-pointer description-task hover-task width-180">{{getDateNoTime(issue.startDate)}}</div>
            <p-calendar [showWeek]="true" [firstDayOfWeek]="1" [hidden]="edit != 'startDate'" [minDate]="today" appendTo = "body" [(ngModel)]="startDate" dateFormat="dd.mm.yy" styleClass="background width-180 h-32 mr-5"></p-calendar>
            <div class="w-15 df">
              <div [hidden]="edit != 'startDate'" (click)="commitIssueEdit()">
                <div  class="task-name-button cxy mr-5">
                  <img src="assets/icons/tick.svg">
                </div>
              </div>
              <div [hidden]="edit != 'startDate'" (click)="cancelIssueEdit()">
                <div  class="task-name-button cxy">
                  <img src="assets/icons/cancel.svg">
                </div>
              </div>
            </div>
          </div>
          <div class="df mt-5">
            <div class="df text-y h-32 normal-text w-40">Срок исполнения</div>
            <div [hidden]="edit == 'dueDate'" (click)="edit = 'dueDate'"  class="pl-3 pt-6 h-32 cursor-pointer description-task hover-task width-180">{{getDateNoTime(issue.dueDate)}}</div>
            <p-calendar [showWeek]="true" [firstDayOfWeek]="1" [hidden]="edit != 'dueDate'" [minDate]="today" appendTo = "body" [(ngModel)]="dueDate" dateFormat="dd.mm.yy" styleClass="background width-180 h-32 mr-5"></p-calendar>
            <div class="w-15 df">
              <div [hidden]="edit != 'dueDate'" (click)="commitIssueEdit()">
                <div  class="task-name-button cxy mr-5">
                  <img src="assets/icons/tick.svg">
                </div>
              </div>
              <div [hidden]="edit != 'dueDate'" (click)="cancelIssueEdit()">
                <div  class="task-name-button cxy">
                  <img src="assets/icons/cancel.svg">
                </div>
              </div>
            </div>
          </div>
          <div class="df mt-5">
            <div class="df text-y line-text normal-text w-40">Проект</div>
            <div [hidden]="edit == 'project'" (click)="edit = 'project'" class="pl-3 pt-6 h-32 cursor-pointer description-task hover-task width-180">{{issue.project}}</div>
            <div [hidden]="edit != 'project'" class="mr-5">
              <p-dropdown class="select" [(ngModel)]="issue.project" [options]="taskProjects" styleClass="width-180 h-32">
              </p-dropdown>
            </div>
            <div class="w-15 df">
              <div [hidden]="edit != 'project'" (click)="commitIssueEdit()">
                <div  class="task-name-button cxy mr-5">
                  <img src="assets/icons/tick.svg">
                </div>
              </div>
              <div [hidden]="edit != 'project'" (click)="cancelIssueEdit()">
                <div  class="task-name-button cxy">
                  <img src="assets/icons/cancel.svg">
                </div>
              </div>
            </div>
          </div>
          <div class="df mt-5">
            <div class="df text-y h-32 normal-text w-40">Отдел</div>
            <div [hidden]="edit == 'department'" (click)="edit = 'department'" class="pl-3 pt-6 h-32 cursor-pointer description-task hover-task width-180">{{getWithNoResult(issue.department)}}</div>
            <div class="mr-5" [hidden]="edit != 'department'">
              <p-dropdown class="select" [(ngModel)]="issue.department" [options]="taskDepartments" styleClass="width-180 h-32">
              </p-dropdown>
            </div>
            <div class="w-15 df">
              <div [hidden]="edit != 'department'" (click)="commitIssueEdit()">
                <div  class="task-name-button cxy mr-5">
                  <img src="assets/icons/tick.svg">
                </div>
              </div>
              <div [hidden]="edit != 'department'" (click)="cancelIssueEdit()">
                <div  class="task-name-button cxy">
                  <img src="assets/icons/cancel.svg">
                </div>
              </div>
            </div>
          </div>
          <div class="df mt-5">
            <div class="df text-y h-32 normal-text w-40">Автор</div>
            <div class="pl-3 df text-y h-32 cursor-pointer description-task w-45">{{auth.getUserName(issue.startedBy)}}</div>
          </div>
          <div class="df mt-5">
            <div class="df text-y h-32 normal-text w-40">Отвественный</div>
            <div class="pl-3 df text-y h-32 cursor-pointer description-task w-45">{{auth.getUserName(issue.responsible)}}</div>
          </div>
          <div class="df mt-5">
            <div class="df text-y h-32 normal-text w-40">Исполнитель</div>
            <div class="pl-3 df text-y h-32 cursor-pointer description-task w-45">{{getAssignedTo(issue.assignedTo)}}</div>
          </div>
          <div class="df mt-5">
            <div class="df text-y h-32 normal-text w-40">Приоритет</div>
            <div [hidden]="edit == 'priority'" (click)="edit = 'priority'" class="pl-3 pt-6 h-32 cursor-pointer description-task hover-task width-180">{{getWithNoResult(issue.priority)}}</div>
            <div class="mr-5" [hidden]="edit != 'priority'">
              <p-dropdown class="select" [(ngModel)]="issue.priority" [options]="taskPriorities" styleClass="width-180 h-32">
              </p-dropdown>
            </div>
            <div class="w-15 df">
              <div [hidden]="edit != 'priority'" (click)="commitIssueEdit()">
                <div  class="task-name-button cxy mr-5">
                  <img src="assets/icons/tick.svg">
                </div>
              </div>
              <div [hidden]="edit != 'priority'" (click)="cancelIssueEdit()">
                <div  class="task-name-button cxy">
                  <img src="assets/icons/cancel.svg">
                </div>
              </div>
            </div>
          </div>
          <div class="df mt-5">
            <div class="df text-y h-32 normal-text w-40">Этап</div>
            <div [hidden]="edit == 'period'" (click)="edit = 'period'" class="pl-3 pt-6 h-32 cursor-pointer description-task hover-task width-180">{{getWithNoResult(issue.period)}}</div>
            <div class="mr-5" [hidden]="edit != 'period'">
              <p-dropdown class="select" [(ngModel)]="issue.period" [options]="taskPeriods" styleClass="width-180 h-32">
              </p-dropdown>
            </div>
            <div class="w-15 df">
              <div [hidden]="edit != 'period'" (click)="commitIssueEdit()">
                <div  class="task-name-button cxy mr-5">
                  <img src="assets/icons/tick.svg">
                </div>
              </div>
              <div [hidden]="edit != 'period'" (click)="cancelIssueEdit()">
                <div  class="task-name-button cxy">
                  <img src="assets/icons/cancel.svg">
                </div>
              </div>
            </div>
          </div>
          <div class="df mt-5">
            <div class="df text-y h-32 normal-text w-40">Сверхурочные</div>
            <div class="pl-3 df text-y h-32 cursor-pointer description-task w-45">{{issue.overtime}}</div>
          </div>
          <div class="df mt-5">
            <div class="df text-y h-32 normal-text w-40">ID задачи</div>
            <div class="pl-3 df text-y h-32 cursor-pointer description-task w-45">{{issue.humanId}}</div>
          </div>
        </div>
      </div>
      <div class="mt-2 min-text">Создано {{getDate(issue.startedDate)}}</div>
    </div>
  </div>
</div>
<div [hidden]="!showImages">
  <div class="image-preview-backdrop" (click)="closeShowImage()">
  </div>
  <div class="image-preview-scale">
    <img #img class="image-preview" data-wheel-zoom [src]="image" style="height: unset; width: unset"/>
  </div>
</div>
<p-confirmDialog acceptLabel="Да" rejectLabel="Нет" header="Подтверждение" icon="pi pi-exclamation-triangle"></p-confirmDialog>
<p-toast key="task" position="bottom-center"></p-toast>
