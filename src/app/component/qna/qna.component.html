<div class="all-page">
  <div class="card">
    <div class="card-head df sticky-card">
      <div class="mr-10">
        <div class="materials-button-qna blue-button cxy" (click)="createQuestion()">
          <div class="pr-10 cxy">
            <img src="assets/icons/plus3.svg" height="18">
          </div>
          <div class="cxy">{{t.tr('Задать вопрос')}}</div>
        </div>
      </div>
      <div class="mr-10">
        <p-dropdown optionLabel="label" class="select" optionValue="value" [(ngModel)]="project" (ngModelChange)="changedProject()" [options]="projects" styleClass="width-200" [placeholder]="t.tr('Проект')"></p-dropdown>
      </div>
      <div class="mr-10">
        <p-dropdown optionLabel="label" class="select" optionValue="value" [(ngModel)]="department" (ngModelChange)="changedDepartment()" [options]="departments" styleClass="width-200" [placeholder]="t.tr('Отдел')"></p-dropdown>
      </div>
      <div class="mr-10" (click)="clearFilters()">
        <div class="materials-button gray-button cxy" (click)="clearFilters()" [pTooltip]="t.tr('Очистить фильтры')" tooltipPosition="top">
          <img src="assets/icons/filter-no.svg" height="18">
        </div>
      </div>
    </div>
    <p-table [value]="questions"
             [scrollable]="true"
             scrollHeight="calc(100vh - 220px)"
             [virtualScroll]="true"
             [virtualRowHeight]="40"
             [reorderableColumns]="false"
             [resizableColumns]="false"
             styleClass="p-datatable-striped"
             responsiveLayout="scroll"
             [globalFilterFields]="['id','doc_number','name','status']">
      <ng-template pTemplate="header">
        <tr class="df">
          <th pSortableColumn="id" class="lxy w-20">{{t.tr('Id')}}
            <p-sortIcon field="id"></p-sortIcon>
          </th>
          <th pSortableColumn="id" class="lxy w-20">{{t.tr('Проект')}}
            <p-sortIcon field="id"></p-sortIcon>
          </th>
          <th pSortableColumn="id" class="lxy w-20">{{t.tr('Отдел')}}
            <p-sortIcon field="id"></p-sortIcon>
          </th>
          <th pSortableColumn="status" class="lxy w-20">{{t.tr('Статус')}}
            <p-sortIcon field="status"></p-sortIcon>
            <p-columnFilter class="filter" [field]="'status'" matchMode="in" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false">
              <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                <p-multiSelect [displaySelectedLabel]="false" [ngModel]="value" [options]="filters.status" optionValue="value" optionLabel="label" [placeholder]="t.tr('Все')" (onChange)="filter($event.value);">
                </p-multiSelect>
              </ng-template>
            </p-columnFilter>
          </th>
          <th pSortableColumn="doc_number" class="lxy">{{t.tr('Номер документа')}}
            <p-sortIcon field="doc_number"></p-sortIcon>
          </th>
          <th pSortableColumn="name" class="lxy">{{t.tr('Тема')}}
            <p-sortIcon field="name"></p-sortIcon>
          </th>
          <th pSortableColumn="assigned_to" class="lxy">{{t.tr('Исполнитель')}}
            <p-sortIcon field="assigned_to"></p-sortIcon>
          </th>
          <th pSortableColumn="started_by" class="lxy-15">{{t.tr('Автор')}}
            <p-sortIcon field="started_by"></p-sortIcon>
            <p-columnFilter class="filter" [field]="'started_by'" matchMode="in" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false">
              <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                <p-multiSelect [displaySelectedLabel]="false" [ngModel]="value" [options]="filters.author" optionValue="value" optionLabel="label" [placeholder]="t.tr('Все')" (onChange)="filter($event.value);">
                </p-multiSelect>
              </ng-template>
            </p-columnFilter>
          </th>
          <th pSortableColumn="start_date" class="lxy">{{t.tr('Дата начала')}}
            <p-sortIcon field="start_date"></p-sortIcon>
          </th>
          <th pSortableColumn="priority" class="lxy">{{t.tr('Приоритет')}}
            <p-sortIcon field="priority"></p-sortIcon>
            <p-columnFilter class="filter" [field]="'priority'" matchMode="in" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false">
              <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                <p-multiSelect [displaySelectedLabel]="false" [ngModel]="value" [options]="filters.priority" optionValue="value" optionLabel="label" [placeholder]="t.tr('Все')" (onChange)="filter($event.value);">
                </p-multiSelect>
              </ng-template>
            </p-columnFilter>
          </th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-q>
        <tr class="cursor-pointer row-table-doc-hover" (click)="openQuestion(q.id)">
          <td class="text-14">{{q.id}}</td>
          <td class="text-14">{{getProject(q.project)}}</td>
          <td class="text-14">{{q.department}}</td>
          <td class="text-14" [innerHTML]="questionStatus(q.status) | safeHtml"></td>
          <td class="text-14">{{q.doc_number}}</td>
          <td class="text-14">{{q.name}}</td>
          <td class="text-14">
            <span *ngIf="q.assigned_to != 'nautic-rus'" [innerHTML]="getUserName(q.assigned_to) | safeHtml"></span>
            <div *ngIf="q.assigned_to == 'nautic-rus'" (click)="assignQuestion(q); $event.stopPropagation();">
              <div  class="materials-button-assignee light-green-button cxy">
                <div class="pr-10 cxy">
                  <img src="assets/icons/check.png" height="16">
                </div>
                <div class="cxy">{{t.tr('Назначить')}}</div>
              </div>
            </div>
          </td>
          <td class="text-14"><span [innerHTML]="getUserName(q.started_by) | safeHtml"></span></td>
          <td class="text-14">{{getDate(q.started_date)}}</td>
          <td class="text-14">{{q.priority}}</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
